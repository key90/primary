<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–û—Ç–∫—Ä—ã—Ç–∫–∞ üíê</title>
<link rel="stylesheet" href="style.css">
<style>
body {
  margin:0;
  font-family:'Segoe UI', sans-serif;
  display:flex; justify-content:center; align-items:center;
  min-height:100vh;
  background: linear-gradient(135deg,#fff8f5,#ffeef0);
}
.card-box {
  position: relative;
  width: 90%;
  max-width: 420px;
  background: #fff;
  border-radius: 20px;
  padding: 30px;
  text-align: center;
  box-shadow: 0 8px 30px rgba(0,0,0,0.1);
  overflow: hidden;
}
.recipient { font-size: 1.5em; font-weight:600; margin-bottom:10px; }
.flowers-line, .message, .sender, .date { margin:10px 0; }
.petal-layer { position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; overflow:hidden; }
.petal { position:absolute; font-size:20px; animation-name:fall; animation-timing-function: linear; }
@keyframes fall { 0%{transform: translateY(-10px);} 100%{transform: translateY(110%);} }
.music-btn {
  position: fixed;
  bottom:20px; right:20px;
  background: rgba(255,255,255,0.8);
  border:none; border-radius:30px;
  padding:10px 18px; font-size:16px;
  box-shadow:0 2px 6px rgba(0,0,0,0.2);
  cursor:pointer; transition:0.3s;
  z-index:1000;
}
.music-btn:hover { background: rgba(255,240,245,0.95); transform:scale(1.05);}
.hidden{display:none;}
</style>
</head>
<body>

<div class="card-box" id="cardBox">
  <div class="petal-layer" id="petalLayer"></div>
  <h1 class="recipient" id="recipientName"></h1>
  <p class="flowers-line" id="flowersLine"></p>
  <p class="message" id="messageText"></p>
  <p class="sender" id="senderLine"></p>
  <p class="date muted" id="dateLine"></p>
</div>

<div id="errorBox" class="hidden">
  –û—Ç–∫—Ä—ã—Ç–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ ‚Äî –¥–∞–Ω–Ω—ã–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω—ã –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.
</div>

<audio id="bgAudio" loop preload="auto">
  <source src="melody.mp3" type="audio/mpeg">
</audio>
<button id="musicBtn" class="music-btn">üéµ –í–∫–ª—é—á–∏—Ç—å –º—É–∑—ã–∫—É</button>

<script>
// –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ base64 Unicode
function b64DecodeUnicode(str) {
  str = str.replace(/-/g,'+').replace(/_/g,'/');
  while(str.length % 4) str += '=';
  return decodeURIComponent(escape(atob(str)));
}

// SHA256 —Ö–µ—à –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
async function sha256hex(msg) {
  const enc = new TextEncoder();
  const data = enc.encode(msg);
  const hash = await crypto.subtle.digest('SHA-256', data);
  return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2,'0')).join('');
}

function showError(){
  document.getElementById('errorBox').classList.remove('hidden');
  document.getElementById('cardBox').classList.add('hidden');
}

(async function(){
  const params = new URLSearchParams(location.search);
  const p = params.get('p');
  if(!p) return showError();
  const parts = p.split('.');
  if(parts.length !== 2) return showError();
  const [b64, checksum] = parts;
  let json;
  try { json = b64DecodeUnicode(b64); } catch(e){ return showError(); }

  const hash = await sha256hex(json);
  if(hash.slice(0,12)!==checksum) return showError();
  let data;
  try { data = JSON.parse(json); } catch(e){ return showError(); }

  document.getElementById('recipientName').textContent = data.recipient || '';
  document.getElementById('messageText').textContent = data.message || '';
  document.getElementById('flowersLine').textContent = data.flowers ? 'üå∑ '+data.flowers : '';
  document.getElementById('senderLine').textContent = data.sender ? '–û—Ç: '+data.sender : '';
  document.getElementById('dateLine').textContent = 'üìÖ '+new Date(data.date || Date.now()).toLocaleDateString('ru-RU');

  // –ª–µ–ø–µ—Å—Ç–∫–∏
  const layer = document.getElementById('petalLayer');
  for(let i=0;i<30;i++){
    const span=document.createElement('span');
    span.className='petal';
    span.textContent='üå∏';
    span.style.left=Math.random()*100+'%';
    span.style.animationDuration=(5+Math.random()*5)+'s';
    span.style.animationDelay=Math.random()*5+'s';
    layer.appendChild(span);
  }

  // –º—É–∑—ã–∫–∞ —Å fade-in
  const audio=document.getElementById('bgAudio');
  const musicBtn=document.getElementById('musicBtn');
  let isPlaying=false;

  function fadeIn(audioEl,duration=3000){
    audioEl.volume=0;
    audioEl.play().catch(()=>{});
    const steps=30;
    let i=0;
    const interval=duration/steps;
    const timer=setInterval(()=>{
      i++;
      audioEl.volume=Math.min(1,i/steps);
      if(i>=steps) clearInterval(timer);
    },interval);
  }

  musicBtn.addEventListener('click',()=>{
    if(!isPlaying){
      fadeIn(audio);
      isPlaying=true;
      musicBtn.textContent='üîá –í—ã–∫–ª—é—á–∏—Ç—å –º—É–∑—ã–∫—É';
    } else {
      audio.pause();
      isPlaying=false;
      musicBtn.textContent='üéµ –í–∫–ª—é—á–∏—Ç—å –º—É–∑—ã–∫—É';
    }
  });

})();
</script>
</body>
</html>
